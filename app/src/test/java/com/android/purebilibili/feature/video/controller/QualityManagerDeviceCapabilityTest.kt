package com.android.purebilibili.feature.video.controller

import kotlin.test.Test
import kotlin.test.assertEquals
import kotlin.test.assertTrue

class QualityManagerDeviceCapabilityTest {

    private val qualityManager = QualityManager()

    @Test
    fun `checkQualityPermission returns unsupported when dolby vision not supported by device`() {
        val result = qualityManager.checkQualityPermission(
            qualityId = 126,
            isLoggedIn = true,
            isVip = true,
            isHdrSupported = true,
            isDolbyVisionSupported = false
        )

        assertEquals(
            QualityPermissionResult.UnsupportedByDevice("Dolby Vision"),
            result
        )
    }

    @Test
    fun `checkQualityPermission returns unsupported when hdr not supported by device`() {
        val result = qualityManager.checkQualityPermission(
            qualityId = 125,
            isLoggedIn = true,
            isVip = true,
            isHdrSupported = false,
            isDolbyVisionSupported = true
        )

        assertEquals(
            QualityPermissionResult.UnsupportedByDevice("HDR"),
            result
        )
    }

    @Test
    fun `checkQualityPermission keeps vip requirement priority`() {
        val result = qualityManager.checkQualityPermission(
            qualityId = 126,
            isLoggedIn = true,
            isVip = false,
            isHdrSupported = true,
            isDolbyVisionSupported = false
        )

        assertTrue(result is QualityPermissionResult.RequiresVip)
    }

    @Test
    fun `getMaxAvailableQuality skips unsupported hdr and dolby tiers`() {
        val result = qualityManager.getMaxAvailableQuality(
            availableQualities = listOf(126, 125, 120, 80),
            isLoggedIn = true,
            isVip = true,
            isHdrSupported = false,
            isDolbyVisionSupported = false
        )

        assertEquals(120, result)
    }
}
